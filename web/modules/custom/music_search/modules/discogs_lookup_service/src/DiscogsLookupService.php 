<?php

namespace Drupal\discogs_lookup;

use GuzzleHttp\ClientInterface;
use Drupal\Core\Config\ConfigFactoryInterface;

class DiscogsLookupService {

  protected $httpClient;
  protected $configFactory;

  public function __construct(ClientInterface $http_client, ConfigFactoryInterface $config_factory) {
    $this->httpClient = $http_client;
    $this->configFactory = $config_factory;
  }

  public function search($query) {
    $config = $this->configFactory->get('discogs_lookup.settings');
    $apiKey = $config->get('api_key');

    $url = 'https://api.discogs.com/database/search?q=' . urlencode($query);
    $response = $this->httpClient->request('GET', $url, [
      'headers' => [
        'Authorization' => 'Discogs key=' . $apiKey,
      ],
    ]);

    return json_decode($response->getBody(), TRUE);
  }
}
